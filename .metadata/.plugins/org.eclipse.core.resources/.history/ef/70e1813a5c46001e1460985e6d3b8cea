package EnergyServices.Service;

import java.io.FileReader;
import java.util.ArrayList;
import java.util.List;

import org.hibernate.internal.build.AllowSysOut;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.opencsv.CSVParser;
import com.opencsv.CSVParserBuilder;
import com.opencsv.CSVReader;
import com.opencsv.CSVReaderBuilder;

import EnergyServices.Entities.Comune;
import EnergyServices.Entities.Provincia;
import EnergyServices.Repository.ProvinciaRepository;

@Service
public class CSVreader {
	
	@Autowired
	ProvinciaRepository provRepo;
	
	
	// -------------- LISTA PROVINCE
	
	public List<Provincia> getListaProvince(String path) {
		
		//creo un array vuoto che conterrà le province
		List<Provincia> listaProvince = new ArrayList<>();
		
		//uso il parser per specificare il separatore utilizzato nela mio file CSV
		CSVParser parser = new CSVParserBuilder().withSeparator(';').build();
		
		//faccio un trycatch per leggere il file passato sfruttando la libreria OPENCSV
		try (CSVReader csvReader = new CSVReaderBuilder(new FileReader(path))
                .withCSVParser(parser)
                .withSkipLines(1) // Salta la riga dell'intestazione
                .build()) {

            String riga[];
            while ((riga = csvReader.readNext()) != null) {
                String sigla = riga[0];
                String provincia = riga[1];
                String regione = riga[2];

                Provincia nuovaProvincia = new Provincia(sigla, provincia, regione);
                listaProvince.add(nuovaProvincia);
                }
            
            provRepo.saveAll(listaProvince);
			
			
		} catch(Exception e) {
			e.printStackTrace();
		}
		return listaProvince;
	}
	
	// -------------- LISTA COMUNI
	
	public List<Comune> getListaComuni(String path) {
		
		List<Comune> listaComuni = new ArrayList<>();
		
		CSVParser parser = new CSVParserBuilder().withSeparator(';').build();
		
		try (CSVReader csvReader = new CSVReaderBuilder(new FileReader(path))
                .withCSVParser(parser)
                .withSkipLines(1) // Salta la riga dell'intestazione
                .build()) {

            String riga[];
            riga = csvReader.readNext();
            System.out.println(riga[0] +" "+ riga[1] +" "+ riga[2] +" "+ riga[3]);
            
//            while ((riga = csvReader.readNext()) != null) {
//                int codiceProvincia = Integer.parseInt(riga[0]);
//                int progressivoComune = Integer.parseInt(riga[1]);
//                String denominazione = riga[2];
//                String nomeProvincia = riga[3];
//                
//                //verifico del il valore del indice 3 è vuoto per l'header
//                if (nomeProvincia.isEmpty()) {
//                    nomeProvincia = "Provincia";
//                }
//
//                Provincia provincia = provRepo.findByProvincia(nomeProvincia);
//                if (provincia != null) {
//                    Comune nuovoComune = new Comune(codiceProvincia, progressivoComune, denominazione, provincia);
//                    nuovoComune.setProvincia(provincia); // Associa la provincia
//                    listaComuni.add(nuovoComune);
//                }else {
//                    System.out.println("Nessuna provincia trovata per il comune: " + denominazione);
//                }
//                }
            
            //provRepo.saveAll(listaProvince);
			
			
		} catch(Exception e) {
			e.printStackTrace();
		}
		return listaComuni;
		
	}
}
